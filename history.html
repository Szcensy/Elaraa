<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ash — Local (Proxy) Therapist</title>
<style>
  /* Calm white + light blue UI, lean & simple */
  :root{--bg:#ffffff;--accent:#7fc6ff;--muted:#6b7280;--text:#052235;}
  body{font-family:Inter, Arial, sans-serif;background:linear-gradient(180deg,#fbfdff,#f6fbff);margin:0;color:var(--text);display:flex;align-items:center;justify-content:center;height:100vh}
  .card{width:100%;max-width:860px;background:#fff;border-radius:14px;box-shadow:0 12px 30px rgba(3,15,40,0.06);overflow:hidden}
  header{padding:18px;border-bottom:1px solid rgba(135,196,255,0.06);display:flex;align-items:center;gap:12px}
  .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#cfefff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  .title{font-weight:700}
  .subtitle{font-size:13px;color:var(--muted)}
  .main{height:66vh;display:flex;flex-direction:column}
  .history{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:12px}
  .msg{max-width:78%;padding:12px 14px;border-radius:12px}
  .ai{align-self:flex-start;background:#e9f6ff;border:1px solid rgba(127,198,255,0.12)}
  .user{align-self:flex-end;background:#f1f5f9}
  .controls{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(135,196,255,0.04);align-items:center}
  textarea{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(10,20,30,0.04);font-size:15px;resize:none;height:56px}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .info{padding:10px 18px;font-size:13px;color:var(--muted);border-top:1px solid rgba(135,196,255,0.02)}
</style>
</head>
<body>
  <div class="card" role="application">
    <header>
      <div class="logo">AH</div>
      <div>
        <div class="title">Ash — Local Therapist</div>
        <div class="subtitle">Calm, reflective listening (local proxy protects your key)</div>
      </div>
    </header>

    <div class="main">
      <div id="history" class="history" aria-live="polite"></div>

      <div class="controls">
        <textarea id="input" placeholder="Share what you're feeling..."></textarea>
        <button id="send">Send</button>
      </div>

      <div class="info">
        This page talks to your local proxy at <code>http://localhost:3000/api/openai/chat</code>. Keep the proxy server running while using this page.
      </div>
    </div>
  </div>

<script>
/* CLIENT: uses the proxy so API key stays on server */
const PROXY_URL = "http://localhost:3000/api/openai/chat";
const CLIENT_SECRET = "my-local-secret-123"; // this must match CLIENT_SECRET in your .env

const SYSTEM_PROMPT = {
  role: "system",
  content: `You are "Ash", a calm, compassionate AI therapist-style companion. Speak gently, reflect feelings, ask open questions, and offer small grounding exercises when appropriate. Avoid clinical diagnoses or prescriptions. Keep answers concise and supportive.`
};

// load small convo from localStorage
let convo = JSON.parse(localStorage.getItem("ash_local_convo") || "null");
if(!convo){
  convo = [
    SYSTEM_PROMPT,
    { role: "assistant", content: "Hi — I'm here. Tell me what's on your mind, in your own time." }
  ];
  localStorage.setItem("ash_local_convo", JSON.stringify(convo));
}

const historyEl = document.getElementById("history");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("send");

function render(){
  historyEl.innerHTML = "";
  convo.forEach(m => {
    if(m.role === "system") return;
    const d = document.createElement("div");
    d.className = "msg " + (m.role === "assistant" ? "ai" : "user");
    d.innerHTML = `<div style="font-size:13px;color:#556">${m.role === 'assistant' ? 'Ash' : 'You'}</div><div style="margin-top:6px">${escapeHtml(m.content)}</div>`;
    historyEl.appendChild(d);
  });
  historyEl.scrollTop = historyEl.scrollHeight;
}

function escapeHtml(s){ return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

render();

sendBtn.onclick = send;
inputEl.addEventListener("keydown", (e) => {
  if(e.key === "Enter" && !e.shiftKey){ e.preventDefault(); send(); }
});

async function send(){
  const txt = inputEl.value.trim();
  if(!txt) return;
  convo.push({ role: "user", content: txt });
  localStorage.setItem("ash_local_convo", JSON.stringify(convo));
  render();
  inputEl.value = "";
  // prepare messages (include system)
  const messages = convo.filter(m => m.role !== "system").slice(-12); // small window
  const body = {
    model: "gpt-3.5-turbo",
    messages: [SYSTEM_PROMPT, ...messages]
  };

  try{
    const resp = await fetch(PROXY_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-client-secret": CLIENT_SECRET
      },
      body: JSON.stringify(body)
    });

    if(!resp.ok){
      const err = await resp.json().catch(()=>null);
      const msg = err?.error || `Proxy error: ${resp.status}`;
      convo.push({ role: "assistant", content: msg });
      localStorage.setItem("ash_local_convo", JSON.stringify(convo));
      render();
      return;
    }

    const data = await resp.json();
    const assistant = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || "Sorry — no response.";
    convo.push({ role: "assistant", content: assistant });
    localStorage.setItem("ash_local_convo", JSON.stringify(convo));
    render();

    // optional: speak response
    if(window.speechSynthesis){
      const u = new SpeechSynthesisUtterance(assistant);
      u.lang = "en-US";
      u.rate = 0.95;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

  } catch(err){
    console.error(err);
    convo.push({ role: "assistant", content: "Network error when contacting proxy." });
    localStorage.setItem("ash_local_convo", JSON.stringify(convo));
    render();
  }
}
</script>
</body>
</html>